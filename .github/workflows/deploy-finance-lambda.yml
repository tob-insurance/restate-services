name: Deploy Finance Lambda

# Temporarily disabled - re-enable when ready for deployment
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "prod"
        type: choice
        options:
          - dev
          - staging
          - prod
      build_layer:
        description: "Build and publish Oracle Lambda layer"
        required: false
        default: false
        type: boolean
  # push:
  #   branches: [main]
  #   paths:
  #     - "apps/finance/**"
  #     - ".github/workflows/deploy-finance-lambda.yml"

env:
  AWS_REGION: ap-southeast-3
  LAMBDA_FUNCTION_NAME: finance-closing
  LAMBDA_LAYER_NAME: oracle-instantclient

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch secrets from Infisical
        uses: Infisical/secrets-action@v1.0.15
        with:
          method: "oidc"
          identity-id: ${{ secrets.INFISICAL_MACHINE_IDENTITY_ID }}
          domain: "https://infisical.tob-insurance.com"
          project-slug: ${{ vars.INFISICAL_PROJECT_SLUG }}
          env-slug: ${{ inputs.environment || 'prod' }}
          export-type: "file"
          file-output-path: "/apps/finance/.env"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build packages
        run: bun run build

      - name: Build Lambda bundle
        run: bun run --filter @restate-tob/finance bundle:lambda

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Lambda Function
        id: deploy
        run: |
          # Get latest Oracle layer version
          LAYER_ARN=$(aws lambda list-layer-versions \
            --layer-name ${{ env.LAMBDA_LAYER_NAME }} \
            --query 'LayerVersions[0].LayerVersionArn' \
            --output text)
          echo "Using Oracle layer: $LAYER_ARN"
          
          # Update function code
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://apps/finance/dist-lambda/lambda.zip
          
          # Wait for code update to complete
          aws lambda wait function-updated --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
          
          # Build environment variables JSON from .env file
          ENV_VARS=$(cat ${{ github.workspace }}/apps/finance/.env | grep -v '^#' | grep '=' | while IFS='=' read -r key value; do
            # Remove quotes from value if present
            value=$(echo "$value" | sed 's/^["'"'"']//' | sed 's/["'"'"']$//')
            echo "\"$key\":\"$value\""
          done | paste -sd ',' -)
          
          # Attach layer and set environment variables
          aws lambda update-function-configuration \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --layers "$LAYER_ARN" \
            --environment "Variables={$ENV_VARS}"

      - name: Register with Restate
        if: success()
        env:
          RESTATE_ADMIN_URL: ${{ secrets.RESTATE_ADMIN_URL }}
          RESTATE_BASIC_AUTH: ${{ secrets.RESTATE_BASIC_AUTH }}
        run: |
          FUNCTION_ARN=$(aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --query 'Configuration.FunctionArn' --output text)
          
          # Wait for Lambda update to complete
          echo "Waiting for Lambda to be ready..."
          aws lambda wait function-updated --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
          
          VERSION=$(aws lambda publish-version --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --query 'Version' --output text)
          VERSIONED_ARN="${FUNCTION_ARN}:${VERSION}"
          echo "Registering Lambda ARN: $VERSIONED_ARN"
          RESPONSE=$(curl -s -w "\n%{http_code}" -u "$RESTATE_BASIC_AUTH" -X POST "$RESTATE_ADMIN_URL/deployments" \
            -H "Content-Type: application/json" \
            -d "{\"arn\": \"$VERSIONED_ARN\", \"assume_role_arn\": \"${{ secrets.AWS_INVOKE_ROLE_ARN }}\", \"force\": true}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "Response: $BODY"
          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "Error: HTTP $HTTP_CODE"
            exit 1
          fi

  build-layer:
    runs-on: ubuntu-latest
    if: inputs.build_layer == true
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Oracle Instant Client Layer
        run: bash packages/lambda-layers/oracle/build-layer.sh

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Publish Lambda Layer
        run: |
          aws lambda publish-layer-version \
            --layer-name ${{ env.LAMBDA_LAYER_NAME }} \
            --zip-file fileb://packages/lambda-layers/oracle/output/oracle-instantclient-layer.zip \
            --compatible-runtimes nodejs18.x nodejs20.x nodejs22.x \
            --compatible-architectures x86_64
